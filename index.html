<!DOCTYPE html>
<!--
Copyright (c) 2014
License GPL2, See the file LICENSE at the root folder for more informations
Robomatix Rebirth - Le Carré Noir
Started the 26 March 2014
-->
<html>
    <head>
        <title>One Minute Shoot' Em Up ! - Le carré noir</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <script type="text/javascript" src="js/phaser.min.js"></script>
        <style type="text/css">
            body {
                margin: 0;
            }
        </style>
        <script type="text/javascript">

            /******************************
             * 
             * VARIABLES
             *******************************/

            // var countdown
            var countdownDisplay = 60;
            var countdownString = '';
            var countdownText;
            // var Hero
            var player;
            var playerMove = 180;
            var bullets;
            var bulletTime = 0;
            var fireButton;
            // var Enemies
            var enemies;
            var bomberMove = 75;
            var bomber1;
            var bomber2;



            /******************************
             * 
             * THE GAME
             *******************************/
            var game = new Phaser.Game(500, 500, Phaser.AUTO, '', {preload: preload, create: create, update: update});

            function preload() {

                game.load.spritesheet('hero', 'assets/picts/hero-hitted-and-damaged.png', 40, 40);
                game.load.image('bullet', 'assets/picts/bullet-hero-1.png');

                game.load.spritesheet('bomber', 'assets/picts/enemy-bomber-1.png', 60, 40, 3);
                game.load.spritesheet('bomberExplode', 'assets/picts/enemy-bomber-1-explode.png', 60, 40, 4);

            }// preload


            function create() {

                // The countdown
                game.time.events.repeat(Phaser.Timer.SECOND * 1, 60, countDown, this);
                countdownString = 'Countdown : ';
                countdownText = game.add.text(100, 100, countdownString + countdownDisplay, {fontSize: '34px', fill: '#fff'});

                //  Our bullet group
                bullets = game.add.group();
                bullets.enableBody = true;
                bullets.physicsBodyType = Phaser.Physics.ARCADE;
                bullets.createMultiple(30, 'bullet');
                bullets.setAll('checkWorldBounds', true);
                bullets.setAll('outOfBoundsKill', true);


                //  The hero!
                player = game.add.sprite(230, 455, 'hero');

                //  We need to enable physics on the player
                game.physics.arcade.enable(player);

                //  And some controls to play the game with
                cursors = game.input.keyboard.createCursorKeys();
                fireButton = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);

                //  Create some baddies to have fun with :)
                enemies = [];

                // Create Bombers
                for (var i = 0; i < 2; i++)
                {
                    enemies.push(new EnemyBomber(game, i));
                }

                // Apparently the second bomber (1) must be created and destroyed in order to get it work with the countdown
                enemies[1].alive = false;
                enemies[1].bomber.kill();


            }// create

            function update() {

                // Enemies Test and actions
                for (var i = 0; i < enemies.length; i++)
                {

                    if (enemies[i].alive)
                    {

                        enemies[i].update();

                    } else {

                        if (enemies[i].bomber.name === '0') {
                            var randomGenerateBomber0 = game.rnd.integerInRange(1, 100000);
                            if (randomGenerateBomber0 > 88888) {
                                enemies[i] = new EnemyBomber(game, 0);
                            }
                        }

                        if (enemies[i].bomber.name === '1' && countdownDisplay < 45) {
                            var randomGenerateBomber1 = game.rnd.integerInRange(1, 100000);
                            if (randomGenerateBomber1 > 88888) {
                                enemies[i] = new EnemyBomber(game, 1);
                            }
                        }

                    }

                }



                //  Reset the player velocity (movement)
                player.body.velocity.x = 0;

                //  Move the player
                if (cursors.left.isDown)
                {
                    if (player.x > 10) {
                        player.body.velocity.x = -playerMove;
                    } else {
                        player.body.velocity.x = 0;
                    }
                }
                else if (cursors.right.isDown)
                {
                    if (player.x < 450) {
                        player.body.velocity.x = playerMove;
                    } else {
                        player.body.velocity.x = 0;
                    }
                }

                //  Firing?
                if (fireButton.isDown)
                {
                    fireBullet();
                }


            }// update

            /******************************
             * 
             * THE GAME'S FUNCTIONS
             *******************************/

            function countDown() {
                countdownDisplay -= 1;
                countdownText.setText(countdownString + countdownDisplay);

            }

            /******************************
             * 
             * THE PLAYER'S FUNCTIONS
             *******************************/
            function fireBullet() {

                //  To avoid them being allowed to fire too fast we set a time limit
                if (game.time.now > bulletTime)
                {
                    //  Grab the first bullet we can from the pool
                    bullet = bullets.getFirstExists(false);

                    if (bullet)
                    {
                        //  And fire it
                        bullet.reset(player.x + 17, player.y + 8);
                        bullet.body.velocity.y = -400;
                        bulletTime = game.time.now + 444;
                    }
                }

            }//fireBullet

            /******************************
             * 
             * THE ENEMIES'S FUNCTIONS
             *******************************/

            // BOMBER
            EnemyBomber = function(game, id) {

                // var
                var lr;
                var y;

                this.game = game;



                // Determinate if the bomber appear on the Left or on the Right
                lr = this.game.rnd.integerInRange(1, 100);

                // The starting position of the bomber and consquently his moving direction
                if (id === 0) {
                    y = 25;
                } else {
                    y = 75;
                }
                if (lr > 50) {
                    var x = -60;
                    this.moveX = bomberMove;
                } else {
                    var x = 560;
                    this.moveX = -bomberMove;
                }


                this.health = 1;
                this.alive = true;



                this.bomber = game.add.sprite(x, y, 'bomber');
                this.game.physics.arcade.enable(this.bomber);
                this.bomber.animations.add('blink');
                this.bomber.animations.play('blink', 3, true);
                this.bomber.name = id.toString();

            };

            EnemyBomber.prototype.update = function() {

                // Moves the bomber
                this.bomber.body.velocity.x = this.moveX;

                if (this.bomber.x < -60 || this.bomber.x > 560) {
                    this.alive = false;
                    this.bomber.kill();
                }
            };
        </script>
    </head>
    <body>

    </body>
</html>
